
# 一、修改hexo配置文件无法生效的问题

起因是我在windows下修改了_config.yml文件, 但是推送之后却发现没有生效, 于是就问AI ,他给出的解释为: deploy.sh 只是执行了 `hexo clean` 和 `hexo generate` 没有重启 hexo 进程。

我的Dockerfile中写的有：

`CMD ["hexo", "server"]`

也就是说我的hexo容器在创建的时候就读取了一次配置，因此配置文件的更改需要重新构建容器才行。

AI 给出的方案是 **`generate + nginx`** 的方案。

也即是 hexo 容器只负责 执行 hexo generate 构建静态的html文件，用 nginx 托管 `public/`

最终的架构如下：

```
GitHub push
  ↓
GitHub Actions
  ↓
SSH 执行 deploy.sh
  ↓
docker compose run hexo hexo generate
  ↓
public/ 生成静态文件
  ↓
nginx 容器直接对外提供访问

```

接下来需要做四步

#### 1、更新docker-compose.yml

```
version: "3.8"

services:
  hexo:
    image: node:18-alpine
    container_name: hexo-builder
    working_dir: /hexo
    volumes:
      - ./blog:/hexo
    command: sh -c "npm install && npx hexo generate"

  nginx:
    image: nginx:alpine
    container_name: hexo-nginx
    ports:
      - "4000:80"
    volumes:
      - ./blog/public:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

```

- `hexo`：**一次性构建器**
    
- `nginx`：**只负责托管 public/**

#### 2、提供挂载的nginx配置文件

`vim nginx.conf`

编辑内容

```
server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    gzip on;
    gzip_types text/plain text/css application/javascript application/json application/xml;
}

```

#### 3、编辑deploy.sh

```
#!/bin/bash
set -e

cd /app/hexo/blog

echo ">>> Pull latest code"
git pull origin master

cd /app/hexo

echo ">>> Generate hexo (clean build)"
docker compose run --rm hexo

echo ">>> Restart nginx"
docker compose up -d nginx

echo ">>> Done"

```

这里 `docker compose run --rm hexo` 就是运行一次性容器启动指定服务的新容器并执行命令

#### 4、启动

`docker compose up -d nginx`

# 二、图示

![[deepseek_mermaid_20251214_738104.png]]